(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{424:function(t,s,a){"use strict";a.r(s);var n=a(23),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"rails資料庫最佳實踐-未完"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rails資料庫最佳實踐-未完"}},[t._v("#")]),t._v(" Rails資料庫最佳實踐 (未完)")]),t._v(" "),a("p",[t._v("在一個古老的Rails項目上工作，我遇到了一些有趣的ActiveRecord代碼，這些代碼要求重構一些愛。我還花了一些時間來加速慢速/多次數據庫調用的頁面。在這兩次經歷之間，我感受到了寫一些“回歸基礎”Rails數據庫最佳實踐的靈感。")]),t._v(" "),a("h2",{attrs:{id:"規則＃1：讓你的數據庫完成它的工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#規則＃1：讓你的數據庫完成它的工作"}},[t._v("#")]),t._v(" 規則＃1：讓你的數據庫完成它的工作")]),t._v(" "),a("p",[t._v("數據庫功能非常豐富，如果使用得當，它們的速度非常快。他們擅長過濾和排序......以及許多其他事情。如果數據庫可以做到這一點，它將比在Ruby中使用相同的東西或任何其他語言更快地完成它。")]),t._v(" "),a("p",[t._v("您可能需要了解DB如何工作，但老實說，您不必非常深入地獲得大部分收益。")]),t._v(" "),a("p",[t._v("我們一般使用Postgres。您選擇的內容不如了解它並使用其功能使您的產品更棒。如果你對Postgres感到好奇，那麼本帖末尾有一些很好的資源。我們喜歡它。")]),t._v(" "),a("p",[t._v("我們的第一個首要規則：讓您的數據庫執行數據庫擅長的功能，而不是在Ruby中執行。")]),t._v(" "),a("h2",{attrs:{id:"規則＃2：編寫高效且可鏈接的-scope"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#規則＃2：編寫高效且可鏈接的-scope"}},[t._v("#")]),t._v(" 規則＃2：編寫高效且可鏈接的 scope")]),t._v(" "),a("p",[t._v("scope 很棒。它們允許您創建簡潔的幫助程序，以訪問在特定情況下相關的數據子集。太糟糕了，他們的實用性可能被一些反模式所扼殺。查看.active此簡化示例中的 scope：")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveRecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Base")]),t._v("\n  has_many "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":projects")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Project")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveRecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Base")]),t._v("\n  belongs_to "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":client")]),t._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Please don't do this...")]),t._v("\n  scope "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":active")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    includes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("select "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("active"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sort_by "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("downcase "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),a("h3",{attrs:{id:"這裡有一些事情會引起關注："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#這裡有一些事情會引起關注："}},[t._v("#")]),t._v(" 這裡有一些事情會引起關注：")]),t._v(" "),a("ol",[a("li",[t._v("scope不返回ActiveRecord關係，因此它不可鏈接也不能與.merge（）一起使用（稍後將更多地合併）。")]),t._v(" "),a("li",[t._v("scope是在Ruby中將較大的數據集過濾為較小的數據集。")]),t._v(" "),a("li",[t._v("scope是在Ruby中排序。")]),t._v(" "),a("li",[t._v("scope是排序，期間。")])]),t._v(" "),a("h3",{attrs:{id:"較好的解決方式是："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#較好的解決方式是："}},[t._v("#")]),t._v(" 較好的解決方式是：")]),t._v(" "),a("ol",[a("li",[t._v("返回一個"),a("code",[t._v("ActiveRecord::Relation")]),t._v("（即不要觸發該查詢！）")])]),t._v(" "),a("p",[t._v("為什麼返回關係更好？關係是可以鏈接的。可鍊式示波器更容易重複使用。當每個scope返回一個Relation時，您可以將多個scope組合到一個查詢中，例如"),a("code",[t._v("Athlete.active.men.older_than(40)")]),t._v("。關係也可以使用"),a("code",[t._v(".merge()")]),t._v("，這是蜜蜂的膝蓋")]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("過濾數據庫中的數據（不是Ruby）")])]),t._v(" "),a("p",[t._v("為什麼在Ruby中過濾是一個壞主意？因為與數據庫中的過濾相比，它真的很慢。對於小數據集（單個和低兩位數），它可能不會產生顯著差異。對於較大的數據集，它可能很大。")]),t._v(" "),a("blockquote",[a("p",[t._v("經驗法則：Ruby必須做的工作越少越好。")])]),t._v(" "),a("p",[t._v("Ruby中的過濾速度較慢，因為：")]),t._v(" "),a("ul",[a("li",[t._v("將數據從數據庫傳輸到應用程序服務器所花費的時間，")]),t._v(" "),a("li",[t._v("ActiveRecord必須解析查詢結果並為每個創建AR模型對象，並且")]),t._v(" "),a("li",[t._v("你的數據庫有索引（對嗎？！），過濾速度非常快，Ruby則沒有。")])]),t._v(" "),a("h2",{attrs:{id:"規則＃3在數據庫中排序（不是在ruby中）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#規則＃3在數據庫中排序（不是在ruby中）"}},[t._v("#")]),t._v(" 規則＃3在數據庫中排序（不是在Ruby中）")]),t._v(" "),a("p",[t._v("排序怎麼樣？它在數據庫中會更快，但除非你處理非常大的數據集，否則它並不會引人注目。這一個更大的問題"),a("code",[t._v(".sort_by")]),t._v("是將觸發查詢，因此，我們失去了我們的關係。這足以在數據庫中完成。")]),t._v(" "),a("h2",{attrs:{id:"規則＃4將排序排除在範圍之外（或在專用範圍內捕獲）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#規則＃4將排序排除在範圍之外（或在專用範圍內捕獲）"}},[t._v("#")]),t._v(" 規則＃4將排序排除在範圍之外（或在專用範圍內捕獲）")]),t._v(" "),a("p",[t._v("由於我們正在嘗試構建可重用的範圍，因此範圍內的每個單個消費者可能不太可能具有相同的排序要求。出於這個原因，我建議將瑣碎的排序全部放在範圍之外。或者，將復合/非平凡排序移動到其自己的範圍，如下所示：")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[t._v("scope "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":ordered")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'LOWER(name) DESC'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("所以如何改善？")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Client")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveRecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Base")]),t._v("\n  has_many "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":projects")]),t._v("\n\n  scope "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":active")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Project")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveRecord")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Model")]),t._v("\n  belongs_to "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":client")]),t._v("\n\n  scope "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":active")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("joins"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("merge"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  \n  scope "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":ordered")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    order"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'LOWER(name)'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("建議")]),t._v(" "),a("p",[t._v("沒有建議")])])])}),[],!1,null,null,null);s.default=e.exports}}]);